<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Edukasi - Pengenalan Pola</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bubblegum+Sans&display=swap');
        
        body {
            font-family: 'Bubblegum Sans', cursive;
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .game-container {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 24px;
            box-shadow: 0 10px 40px rgba(31, 38, 135, 0.3);
            border: 3px solid #fff;
            position: relative;
            overflow: hidden;
        }
        
        .game-container::before {
            content: "";
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: linear-gradient(45deg, #ff9a9e, #fad0c4, #fad0c4, #a1c4fd);
            background-size: 400% 400%;
            z-index: -1;
            filter: blur(20px);
            animation: gradientBG 15s ease infinite;
            border-radius: 30px;
            opacity: 0.7;
        }
        
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
            transition: all 0.3s ease;
            box-shadow: 0 6px 0 #0288d1;
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary:hover {
            transform: translateY(3px);
            box-shadow: 0 3px 0 #0288d1;
        }
        
        .btn-primary::after {
            content: "";
            position: absolute;
            top: -50%;
            left: -60%;
            width: 20px;
            height: 200%;
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(30deg);
            transition: all 0.6s;
        }
        
        .btn-primary:hover::after {
            left: 120%;
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #ffbb00 0%, #f8d683 100%);
            transition: all 0.3s ease;
            box-shadow: 0 6px 0 #e69500;
        }
        
        .btn-secondary:hover {
            transform: translateY(3px);
            box-shadow: 0 3px 0 #e69500;
        }
        
        .draggable {
            cursor: grab;
            transition: transform 0.15s, box-shadow 0.15s;
            transform-origin: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            user-select: none;
            touch-action: none;
            will-change: transform;
        }
        
        .draggable:active {
            cursor: grabbing;
            transform: scale(1.05);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }
        
        .draggable.dragging {
            opacity: 0.8;
            transform: scale(1.05);
            z-index: 1000;
        }
        
        .dropzone {
            border: 4px dashed #b0bec5;
            background-color: rgba(176, 190, 197, 0.1);
            transition: all 0.2s ease;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
        }
        
        .dropzone.highlight {
            border-color: #4fc3f7;
            background-color: rgba(79, 195, 247, 0.1);
            transform: scale(1.02);
        }
        
        .dropzone.correct {
            border-color: #66bb6a;
            background-color: rgba(102, 187, 106, 0.1);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(102, 187, 106, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(102, 187, 106, 0); }
            100% { box-shadow: 0 0 0 0 rgba(102, 187, 106, 0); }
        }
        
        .item-container {
            min-height: 90px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 8px;
        }
        
        .confetti {
            position: absolute;
            width: 15px;
            height: 15px;
            background-color: #f44336;
            border-radius: 50%;
            animation: fall 3s ease-in infinite;
        }
        
        @keyframes fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        .bounce-animation {
            animation: bounce 0.5s;
        }
        
        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        .shake-animation {
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        
        .level-badge {
            position: absolute;
            top: -15px;
            left: -15px;
            width: 80px;
            height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(45deg, #ff9a9e 0%, #fad0c4 100%);
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 10;
            transform: rotate(-15deg);
            border: 3px solid white;
        }
        
        .progress-bar {
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #42a5f5, #4facfe);
            border-radius: 10px;
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                rgba(255,255,255,0) 0%,
                rgba(255,255,255,0.4) 50%,
                rgba(255,255,255,0) 100%
            );
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .floating {
            animation: floating 3s ease-in-out infinite;
        }
        
        @keyframes floating {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0px); }
        }
        
        .stars {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        
        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            animation: twinkle 2s infinite;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        /* Kompak item styling */
        .compact-item {
            font-size: 1.75rem;
            padding: 0.5rem;
            margin: 0.25rem;
        }
        
        /* Sticky container untuk item */
        .sticky-container {
            position: sticky;
            bottom: 0;
            z-index: 10;
            padding: 0.75rem;
            border-top: 2px solid #e0e0e0;
            background: linear-gradient(to bottom, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.98) 100%);
            box-shadow: 0 -5px 10px rgba(0,0,0,0.05);
            border-radius: 0 0 24px 24px;
            margin-top: 0.5rem;
        }
        
        /* Compact grid layout */
        .compact-grid {
            grid-gap: 0.75rem;
        }
        
        /* Responsive container */
        .game-content {
            max-height: calc(100vh - 180px);
            overflow-y: auto;
            padding-bottom: 0.5rem;
            scrollbar-width: thin;
        }
        
        .game-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .game-content::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.05);
            border-radius: 10px;
        }
        
        .game-content::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">
    <div class="stars"></div>
    
    <!-- Halaman Utama -->
    <div id="home-screen" class="game-container w-full max-w-3xl p-8 text-center">
        <h1 class="text-4xl md:text-5xl font-bold text-blue-500 mb-4">Game Edukasi ‚Äì Pengenalan Pola</h1>
        <h2 class="text-xl md:text-2xl text-yellow-600 mb-8">Latihan Mengelompokkan Berdasarkan Sifat atau Karakteristik Objek</h2>
        
        <div class="flex justify-center space-x-8 mb-12">
            <div class="floating text-6xl" style="animation-delay: 0s">üéÆ</div>
            <div class="floating text-6xl" style="animation-delay: 0.5s">üß©</div>
            <div class="floating text-6xl" style="animation-delay: 1s">üéØ</div>
        </div>
        
        <button id="start-button" class="btn-primary text-white font-bold py-4 px-10 rounded-full text-xl">
            Mainkan Sekarang
        </button>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="game-container w-full max-w-4xl hidden relative flex flex-col">
        <div class="level-badge">
            <span id="level-number" class="text-white text-2xl font-bold">1</span>
        </div>
        
        <div class="flex justify-between items-center mb-3 mt-2 px-6 pt-4">
            <h2 id="level-title" class="text-2xl font-bold text-blue-500 ml-16">Level 1</h2>
            <div id="level-progress" class="text-lg font-bold text-green-500">0/9</div>
        </div>
        
        <div class="progress-bar mx-6">
            <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
        </div>
        
        <div id="level-instruction" class="bg-yellow-100 p-3 rounded-lg mx-6 mb-4 text-center text-lg">
            Seret dan kelompokkan objek-objek berikut berdasarkan bentuknya!
        </div>
        
        <!-- Game content with scrollable area -->
        <div class="game-content px-6 flex-grow">
            <div id="dropzones-container" class="grid grid-cols-1 md:grid-cols-2 compact-grid mb-4">
                <div id="dropzone-1" class="dropzone rounded-lg p-3">
                    <div class="text-center mb-1 font-bold text-lg" id="category-1">Kategori 1</div>
                    <div class="item-container" data-dropzone="1"></div>
                </div>
                
                <div id="dropzone-2" class="dropzone rounded-lg p-3">
                    <div class="text-center mb-1 font-bold text-lg" id="category-2">Kategori 2</div>
                    <div class="item-container" data-dropzone="2"></div>
                </div>
                
                <div id="dropzone-3" class="dropzone rounded-lg p-3">
                    <div class="text-center mb-1 font-bold text-lg" id="category-3">Kategori 3</div>
                    <div class="item-container" data-dropzone="3"></div>
                </div>
                
                <!-- Dropzone 4 akan ditampilkan hanya pada level 5 -->
                <div id="dropzone-4" class="dropzone rounded-lg p-3 hidden">
                    <div class="text-center mb-1 font-bold text-lg" id="category-4">Kategori 4</div>
                    <div class="item-container" data-dropzone="4"></div>
                </div>
            </div>
        </div>
        
        <!-- Sticky container for items -->
        <div class="sticky-container">
            <div id="items-container" class="bg-gradient-to-r from-blue-50 to-purple-50 p-3 rounded-lg flex flex-wrap justify-center gap-2 shadow-inner">
                <!-- Items will be dynamically added here -->
            </div>
            
            <div class="mt-4 text-center flex justify-center gap-4">
                <button id="check-answer" class="btn-primary text-white font-bold py-2 px-6 rounded-full text-lg">
                    Periksa Jawaban
                </button>
                <button id="reset-level" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-full text-lg">
                    Ulangi
                </button>
            </div>
        </div>
    </div>

    <!-- Completion Screen -->
    <div id="completion-screen" class="game-container w-full max-w-3xl p-8 text-center hidden">
        <h2 class="text-3xl font-bold text-green-500 mb-4">Kamu Hebat! Terus Berlatih Mengenali Pola!</h2>
        
        <div class="flex justify-center my-8">
            <div class="text-8xl floating">üèÜ</div>
        </div>
        
        <p class="text-xl mb-8">Kamu telah menyelesaikan semua level dengan baik!</p>
        
        <div class="flex justify-center space-x-4">
            <button id="play-again" class="btn-primary text-white font-bold py-3 px-8 rounded-full text-lg">
                Main Ulang
            </button>
            <button id="home-button" class="btn-secondary text-white font-bold py-3 px-8 rounded-full text-lg">
                Kembali ke Beranda
            </button>
        </div>
    </div>

    <script>
        // Game data
        const levels = [
            {
                title: "Level 1: Kenali Pola Bentuk",
                instruction: "Seret dan kelompokkan objek-objek berikut berdasarkan bentuknya!",
                categories: ["Hati", "Persegi", "Lingkaran"],
                items: [
                    { id: "item-1-1", content: "‚ù§Ô∏è", category: "Hati" },
                    { id: "item-1-2", content: "üíô", category: "Hati" },
                    { id: "item-1-3", content: "üíö", category: "Hati" },
                    { id: "item-1-4", content: "üü•", category: "Persegi" },
                    { id: "item-1-5", content: "üü¶", category: "Persegi" },
                    { id: "item-1-6", content: "üü©", category: "Persegi" },
                    { id: "item-1-7", content: "üî¥", category: "Lingkaran" },
                    { id: "item-1-8", content: "üîµ", category: "Lingkaran" },
                    { id: "item-1-9", content: "üü¢", category: "Lingkaran" }
                ]
            },
            {
                title: "Level 2: Kenali Pola Warna",
                instruction: "Seret dan kelompokkan objek-objek berikut berdasarkan warnanya!",
                categories: ["Merah", "Biru", "Hijau"],
                items: [
                    { id: "item-2-1", content: "üçé", category: "Merah" },
                    { id: "item-2-2", content: "üçì", category: "Merah" },
                    { id: "item-2-3", content: "üöí", category: "Merah" },
                    { id: "item-2-4", content: "üê¨", category: "Biru" },
                    { id: "item-2-5", content: "üåä", category: "Biru" },
                    { id: "item-2-6", content: "üß¢", category: "Biru" },
                    { id: "item-2-7", content: "ü•ù", category: "Hijau" },
                    { id: "item-2-8", content: "üê∏", category: "Hijau" },
                    { id: "item-2-9", content: "üå≤", category: "Hijau" }
                ]
            },
            {
                title: "Level 3: Kenali Pola Jenis Hewan",
                instruction: "Seret dan kelompokkan hewan-hewan berikut berdasarkan jenisnya!",
                categories: ["Mamalia", "Burung", "Ikan/Laut"],
                items: [
                    { id: "item-3-1", content: "üêò", category: "Mamalia" },
                    { id: "item-3-2", content: "üê∂", category: "Mamalia" },
                    { id: "item-3-3", content: "üê±", category: "Mamalia" },
                    { id: "item-3-4", content: "ü¶Ö", category: "Burung" },
                    { id: "item-3-5", content: "ü¶ú", category: "Burung" },
                    { id: "item-3-6", content: "üêß", category: "Burung" },
                    { id: "item-3-7", content: "üê†", category: "Ikan/Laut" },
                    { id: "item-3-8", content: "üêô", category: "Ikan/Laut" },
                    { id: "item-3-9", content: "ü¶à", category: "Ikan/Laut" }
                ]
            },
            {
                title: "Level 4: Kenali Pola Kategori Benda",
                instruction: "Seret dan kelompokkan benda-benda berikut berdasarkan kategorinya!",
                categories: ["Alat Tulis", "Kendaraan", "Makanan"],
                items: [
                    { id: "item-4-1", content: "‚úèÔ∏è", category: "Alat Tulis" },
                    { id: "item-4-2", content: "üìö", category: "Alat Tulis" },
                    { id: "item-4-3", content: "üìù", category: "Alat Tulis" },
                    { id: "item-4-4", content: "üöó", category: "Kendaraan" },
                    { id: "item-4-5", content: "‚úàÔ∏è", category: "Kendaraan" },
                    { id: "item-4-6", content: "üö≤", category: "Kendaraan" },
                    { id: "item-4-7", content: "üçï", category: "Makanan" },
                    { id: "item-4-8", content: "üç¶", category: "Makanan" },
                    { id: "item-4-9", content: "üçî", category: "Makanan" }
                ]
            },
            {
                title: "Level 5: Kenali Pola Ekspresi Emosi",
                instruction: "Seret dan kelompokkan emoji berikut berdasarkan ekspresi emosinya!",
                categories: ["Senang", "Sedih", "Terkejut", "Marah"],
                items: [
                    { id: "item-5-1", content: "üòÄ", category: "Senang" },
                    { id: "item-5-2", content: "üòÑ", category: "Senang" },
                    { id: "item-5-3", content: "ü•≥", category: "Senang" },
                    { id: "item-5-4", content: "üò¢", category: "Sedih" },
                    { id: "item-5-5", content: "üò≠", category: "Sedih" },
                    { id: "item-5-6", content: "üòû", category: "Sedih" },
                    { id: "item-5-7", content: "üò≤", category: "Terkejut" },
                    { id: "item-5-8", content: "üòÆ", category: "Terkejut" },
                    { id: "item-5-9", content: "üò±", category: "Terkejut" },
                    { id: "item-5-10", content: "üò†", category: "Marah" },
                    { id: "item-5-11", content: "üò°", category: "Marah" },
                    { id: "item-5-12", content: "ü§¨", category: "Marah" }
                ]
            }
        ];

        // Game state
        let currentLevel = 0;
        let correctItems = 0;
        let draggedItem = null;
        let lastFrameTime = 0;
        let isDragging = false;

        // DOM Elements
        const homeScreen = document.getElementById('home-screen');
        const gameScreen = document.getElementById('game-screen');
        const completionScreen = document.getElementById('completion-screen');
        
        const levelTitle = document.getElementById('level-title');
        const levelNumber = document.getElementById('level-number');
        const levelInstruction = document.getElementById('level-instruction');
        const levelProgress = document.getElementById('level-progress');
        const progressFill = document.getElementById('progress-fill');
        const itemsContainer = document.getElementById('items-container');
        const dropzonesContainer = document.getElementById('dropzones-container');
        
        const category1 = document.getElementById('category-1');
        const category2 = document.getElementById('category-2');
        const category3 = document.getElementById('category-3');
        const category4 = document.getElementById('category-4');
        const dropzone4 = document.getElementById('dropzone-4');
        
        // Create stars background (reduced count for better performance)
        function createStars() {
            const starsContainer = document.querySelector('.stars');
            const starCount = 30; // Reduced from 50
            
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                
                // Random position
                const x = Math.random() * 100;
                const y = Math.random() * 100;
                
                // Random size
                const size = Math.random() * 3 + 1;
                
                // Random animation delay
                const delay = Math.random() * 2;
                
                star.style.left = `${x}%`;
                star.style.top = `${y}%`;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.animationDelay = `${delay}s`;
                
                starsContainer.appendChild(star);
            }
        }
        
        // Event Listeners
        document.getElementById('start-button').addEventListener('click', startGame);
        document.getElementById('check-answer').addEventListener('click', checkAnswers);
        document.getElementById('reset-level').addEventListener('click', resetLevel);
        document.getElementById('play-again').addEventListener('click', () => {
            currentLevel = 0;
            startLevel(currentLevel);
        });
        document.getElementById('home-button').addEventListener('click', showHomeScreen);

        // Throttle function to limit how often a function can be called
        function throttle(callback, delay = 16) {
            let previousCall = Date.now() - delay;
            return function(...args) {
                const now = Date.now();
                if (now - previousCall >= delay) {
                    previousCall = now;
                    callback.apply(this, args);
                }
            };
        }

        // Functions
        function showHomeScreen() {
            homeScreen.classList.remove('hidden');
            gameScreen.classList.add('hidden');
            completionScreen.classList.add('hidden');
        }

        function startGame() {
            currentLevel = 0;
            startLevel(currentLevel);
        }

        function startLevel(levelIndex) {
            homeScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            completionScreen.classList.add('hidden');
            
            const level = levels[levelIndex];
            
            // Set level info
            levelTitle.textContent = level.title;
            levelNumber.textContent = levelIndex + 1;
            levelInstruction.textContent = level.instruction;
            levelProgress.textContent = `0/${level.items.length}`;
            progressFill.style.width = '0%';
            correctItems = 0;
            
            // Adjust grid layout based on number of categories
            if (level.categories.length === 4) {
                dropzonesContainer.classList.remove('md:grid-cols-3');
                dropzonesContainer.classList.add('md:grid-cols-2');
                dropzone4.classList.remove('hidden');
            } else {
                dropzonesContainer.classList.add('md:grid-cols-3');
                dropzonesContainer.classList.remove('md:grid-cols-2');
                dropzone4.classList.add('hidden');
            }
            
            // Set category names
            category1.textContent = level.categories[0];
            category2.textContent = level.categories[1];
            category3.textContent = level.categories[2];
            if (level.categories.length === 4) {
                category4.textContent = level.categories[3];
            }
            
            // Clear dropzones
            document.querySelectorAll('.item-container').forEach(container => {
                container.innerHTML = '';
            });
            
            // Clear and add items
            itemsContainer.innerHTML = '';
            
            // Shuffle items
            const shuffledItems = [...level.items].sort(() => Math.random() - 0.5);
            
            // Create a document fragment for better performance
            const fragment = document.createDocumentFragment();
            
            shuffledItems.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.id = item.id;
                itemElement.className = 'draggable compact-item bg-white rounded-lg shadow-md cursor-grab';
                itemElement.setAttribute('data-category', item.category);
                itemElement.textContent = item.content;
                
                // Add mouse drag events
                itemElement.addEventListener('mousedown', dragStart);
                
                // Add touch events for mobile
                itemElement.addEventListener('touchstart', touchStart, { passive: false });
                
                fragment.appendChild(itemElement);
            });
            
            // Append all items at once
            itemsContainer.appendChild(fragment);
            
            // Add drop events to dropzones
            document.querySelectorAll('.dropzone').forEach(dropzone => {
                // Reset dropzone styles
                dropzone.classList.remove('correct');
                dropzone.classList.remove('highlight');
            });
            
            // Remove any existing global event listeners
            document.removeEventListener('mousemove', throttledDragMove);
            document.removeEventListener('mouseup', dragEnd);
            document.removeEventListener('touchmove', throttledTouchMove);
            document.removeEventListener('touchend', touchEnd);
            
            // Add global mouse events
            document.addEventListener('mousemove', throttledDragMove);
            document.addEventListener('mouseup', dragEnd);
            
            // Add global touch events
            document.addEventListener('touchmove', throttledTouchMove, { passive: false });
            document.addEventListener('touchend', touchEnd);
            
            // Scroll to top of game content
            document.querySelector('.game-content').scrollTop = 0;
        }

        // Throttled event handlers
        const throttledDragMove = throttle(dragMove, 16); // ~60fps
        const throttledTouchMove = throttle(touchMove, 16); // ~60fps

        // Mouse drag functions
        function dragStart(e) {
            if (e.button !== 0) return; // Only left mouse button
            
            draggedItem = this;
            isDragging = true;
            
            // Calculate offset for smoother dragging
            const rect = draggedItem.getBoundingClientRect();
            draggedItem.offsetX = e.clientX - rect.left;
            draggedItem.offsetY = e.clientY - rect.top;
            
            // Add dragging class
            draggedItem.classList.add('dragging');
            
            e.preventDefault();
        }

        function dragMove(e) {
            if (!draggedItem || !isDragging) return;
            
            // Use requestAnimationFrame for smoother animation
            requestAnimationFrame(() => {
                const x = e.clientX - draggedItem.offsetX;
                const y = e.clientY - draggedItem.offsetY;
                
                draggedItem.style.position = 'fixed';
                draggedItem.style.top = `${y}px`;
                draggedItem.style.left = `${x}px`;
                draggedItem.style.zIndex = 1000;
                
                // Find dropzone under the cursor
                const dropzone = getDropzoneUnderPoint(e.clientX, e.clientY);
                
                // Highlight dropzone
                document.querySelectorAll('.dropzone').forEach(dz => {
                    dz.classList.remove('highlight');
                });
                
                if (dropzone) {
                    dropzone.classList.add('highlight');
                }
                
                // Auto-scroll when near edges
                const gameContent = document.querySelector('.game-content');
                const rect = gameContent.getBoundingClientRect();
                const scrollSpeed = 10;
                
                // Scroll up when near top edge
                if (e.clientY < rect.top + 50) {
                    gameContent.scrollTop -= scrollSpeed;
                }
                
                // Scroll down when near bottom edge
                if (e.clientY > rect.bottom - 50) {
                    gameContent.scrollTop += scrollSpeed;
                }
            });
        }

        function dragEnd(e) {
            if (!draggedItem || !isDragging) return;
            
            isDragging = false;
            
            // Find dropzone under the cursor
            const dropzone = getDropzoneUnderPoint(e.clientX, e.clientY);
            
            if (dropzone) {
                // Move item to dropzone
                const container = dropzone.querySelector('.item-container');
                
                // Reset item style
                draggedItem.style.position = '';
                draggedItem.style.top = '';
                draggedItem.style.left = '';
                draggedItem.style.zIndex = '';
                
                container.appendChild(draggedItem);
                
                // Update progress
                updateProgress();
            } else {
                // Return to original position
                draggedItem.style.position = '';
                draggedItem.style.top = '';
                draggedItem.style.left = '';
                draggedItem.style.zIndex = '';
                
                // Check if it was in a dropzone before
                if (draggedItem.parentElement.classList.contains('item-container')) {
                    // If it was in a dropzone, move it back to items container
                    itemsContainer.appendChild(draggedItem);
                    
                    // Update progress
                    updateProgress();
                }
            }
            
            // Remove highlight from all dropzones
            document.querySelectorAll('.dropzone').forEach(dz => {
                dz.classList.remove('highlight');
            });
            
            // Remove dragging class
            draggedItem.classList.remove('dragging');
            draggedItem = null;
        }

        // Touch events for mobile
        function touchStart(e) {
            if (e.touches.length !== 1) return;
            
            draggedItem = this;
            isDragging = true;
            
            // Calculate offset for smoother dragging
            const touch = e.touches[0];
            const rect = draggedItem.getBoundingClientRect();
            draggedItem.offsetX = touch.clientX - rect.left;
            draggedItem.offsetY = touch.clientY - rect.top;
            
            // Add dragging class
            draggedItem.classList.add('dragging');
            
            e.preventDefault();
        }

        function touchMove(e) {
            if (!draggedItem || !isDragging || e.touches.length !== 1) return;
            
            // Use requestAnimationFrame for smoother animation
            requestAnimationFrame(() => {
                const touch = e.touches[0];
                const x = touch.clientX - draggedItem.offsetX;
                const y = touch.clientY - draggedItem.offsetY;
                
                draggedItem.style.position = 'fixed';
                draggedItem.style.top = `${y}px`;
                draggedItem.style.left = `${x}px`;
                draggedItem.style.zIndex = 1000;
                
                // Find dropzone under the touch point
                const dropzone = getDropzoneUnderPoint(touch.clientX, touch.clientY);
                
                // Highlight dropzone
                document.querySelectorAll('.dropzone').forEach(dz => {
                    dz.classList.remove('highlight');
                });
                
                if (dropzone) {
                    dropzone.classList.add('highlight');
                }
                
                // Auto-scroll when near edges
                const gameContent = document.querySelector('.game-content');
                const rect = gameContent.getBoundingClientRect();
                const scrollSpeed = 10;
                
                // Scroll up when near top edge
                if (touch.clientY < rect.top + 50) {
                    gameContent.scrollTop -= scrollSpeed;
                }
                
                // Scroll down when near bottom edge
                if (touch.clientY > rect.bottom - 50) {
                    gameContent.scrollTop += scrollSpeed;
                }
            });
            
            e.preventDefault();
        }

        function touchEnd(e) {
            if (!draggedItem || !isDragging) return;
            
            isDragging = false;
            
            // Get the last touch position
            let x, y;
            if (e.changedTouches && e.changedTouches.length > 0) {
                const touch = e.changedTouches[0];
                x = touch.clientX;
                y = touch.clientY;
            } else {
                // Fallback to the last known position
                const rect = draggedItem.getBoundingClientRect();
                x = rect.left + rect.width / 2;
                y = rect.top + rect.height / 2;
            }
            
            // Find dropzone under the touch point
            const dropzone = getDropzoneUnderPoint(x, y);
            
            if (dropzone) {
                // Move item to dropzone
                const container = dropzone.querySelector('.item-container');
                
                // Reset item style
                draggedItem.style.position = '';
                draggedItem.style.top = '';
                draggedItem.style.left = '';
                draggedItem.style.zIndex = '';
                
                container.appendChild(draggedItem);
                
                // Update progress
                updateProgress();
            } else {
                // Return to original position
                draggedItem.style.position = '';
                draggedItem.style.top = '';
                draggedItem.style.left = '';
                draggedItem.style.zIndex = '';
                
                // Check if it was in a dropzone before
                if (draggedItem.parentElement.classList.contains('item-container')) {
                    // If it was in a dropzone, move it back to items container
                    itemsContainer.appendChild(draggedItem);
                    
                    // Update progress
                    updateProgress();
                }
            }
            
            // Remove highlight from all dropzones
            document.querySelectorAll('.dropzone').forEach(dz => {
                dz.classList.remove('highlight');
            });
            
            // Remove dragging class
            draggedItem.classList.remove('dragging');
            draggedItem = null;
        }

        // Helper function to find dropzone under a point
        function getDropzoneUnderPoint(x, y) {
            const elements = document.elementsFromPoint(x, y);
            
            for (const element of elements) {
                if (element.classList.contains('dropzone')) {
                    return element;
                }
                
                if (element.parentElement && element.parentElement.classList.contains('dropzone')) {
                    return element.parentElement;
                }
                
                if (element.classList.contains('item-container')) {
                    return element.closest('.dropzone');
                }
            }
            
            return null;
        }

        function updateProgress() {
            const level = levels[currentLevel];
            const itemsInDropzones = document.querySelectorAll('.dropzone .draggable').length;
            levelProgress.textContent = `${itemsInDropzones}/${level.items.length}`;
            
            // Update progress bar
            const progressPercentage = (itemsInDropzones / level.items.length) * 100;
            progressFill.style.width = `${progressPercentage}%`;
        }

        function checkAnswers() {
            let allCorrect = true;
            correctItems = 0;
            
            // Check each dropzone
            document.querySelectorAll('.dropzone:not(.hidden)').forEach((dropzone, index) => {
                const category = levels[currentLevel].categories[index];
                const items = dropzone.querySelectorAll('.draggable');
                
                let dropzoneCorrect = true;
                
                items.forEach(item => {
                    const itemCategory = item.getAttribute('data-category');
                    
                    if (itemCategory === category) {
                        item.classList.add('bg-green-100');
                        item.classList.add('bounce-animation');
                        correctItems++;
                    } else {
                        item.classList.add('bg-red-100');
                        item.classList.add('shake-animation');
                        dropzoneCorrect = false;
                        allCorrect = false;
                    }
                });
                
                if (dropzoneCorrect && items.length > 0) {
                    dropzone.classList.add('correct');
                }
            });
            
            // Update progress
            levelProgress.textContent = `${correctItems}/${levels[currentLevel].items.length}`;
            const progressPercentage = (correctItems / levels[currentLevel].items.length) * 100;
            progressFill.style.width = `${progressPercentage}%`;
            
            // Remove animation classes after they finish
            setTimeout(() => {
                document.querySelectorAll('.bounce-animation, .shake-animation').forEach(el => {
                    el.classList.remove('bounce-animation');
                    el.classList.remove('shake-animation');
                });
            }, 500);
            
            // If all correct, show completion or next level
            if (allCorrect && correctItems === levels[currentLevel].items.length) {
                // Show celebration
                createConfetti();
                
                // Show next level or completion
                setTimeout(() => {
                    if (currentLevel < levels.length - 1) {
                        // Go to next level
                        currentLevel++;
                        startLevel(currentLevel);
                    } else {
                        // Show completion screen
                        showCompletionScreen();
                    }
                }, 2000);
            }
        }

        function resetLevel() {
            startLevel(currentLevel);
        }

        function showCompletionScreen() {
            homeScreen.classList.add('hidden');
            gameScreen.classList.add('hidden');
            completionScreen.classList.remove('hidden');
            
            createConfetti();
        }

        function createConfetti() {
            const confettiContainer = document.createElement('div');
            confettiContainer.style.position = 'fixed';
            confettiContainer.style.top = '0';
            confettiContainer.style.left = '0';
            confettiContainer.style.width = '100%';
            confettiContainer.style.height = '100%';
            confettiContainer.style.pointerEvents = 'none';
            confettiContainer.style.zIndex = '1000';
            document.body.appendChild(confettiContainer);
            
            const colors = ['#f44336', '#2196f3', '#ffeb3b', '#4caf50', '#9c27b0', '#ff9800', '#e91e63'];
            const shapes = ['circle', 'square', 'triangle'];
            
            // Reduced confetti count for better performance
            const confettiCount = 80; // Reduced from 150
            
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                
                // Random shape
                const shape = shapes[Math.floor(Math.random() * shapes.length)];
                
                if (shape === 'circle') {
                    confetti.style.borderRadius = '50%';
                } else if (shape === 'triangle') {
                    confetti.style.width = '0';
                    confetti.style.height = '0';
                    confetti.style.borderLeft = '10px solid transparent';
                    confetti.style.borderRight = '10px solid transparent';
                    confetti.style.borderBottom = '20px solid ' + colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.backgroundColor = 'transparent';
                } else {
                    // Square is default
                    confetti.style.borderRadius = '0';
                }
                
                confetti.style.position = 'absolute';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.backgroundColor = shape === 'triangle' ? 'transparent' : colors[Math.floor(Math.random() * colors.length)];
                confetti.style.width = shape === 'triangle' ? '0' : (Math.random() * 10 + 5) + 'px';
                confetti.style.height = shape === 'triangle' ? '0' : (Math.random() * 10 + 5) + 'px';
                confetti.style.opacity = Math.random();
                confetti.style.animation = `fall ${Math.random() * 3 + 2}s ease-in infinite`;
                confetti.style.animationDelay = Math.random() * 2 + 's';
                
                confettiContainer.appendChild(confetti);
            }
            
            setTimeout(() => {
                confettiContainer.remove();
            }, 5000);
        }

        // Initialize the game
        createStars();
        showHomeScreen();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96591d0ee2767e23',t:'MTc1MzU4NzYwNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
